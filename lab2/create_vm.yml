- name: Create a public IP address
  azure.azcollection.azure_rm_publicipaddress:
    resource_group: "{{ resource_group }}"
    allocation_method: Static
    name: "{{ vm_name }}PublicIP"
    domain_name_label: "{{ vm_name }}-dns"

- name: Create a network interface
  azure.azcollection.azure_rm_networkinterface:
    resource_group: "{{ resource_group }}"
    name: "{{vm_name}}{{ network_interface_name }}"
    virtual_network: "{{ network_name }}"
    subnet: "{{ subnet_name }}"
    security_group: "{{ nsg_name }}"
    ip_configurations:
      - name: "{{vm_name}}ipconfig"
        private_ip_address: "{{ vm_private_ip }}"
        private_ip_allocation_method: Static
        public_ip_address_name: "{{ vm_name }}PublicIP"


- name: Create virtual machine
  azure.azcollection.azure_rm_virtualmachine:
    resource_group: "{{ resource_group }}"
    name: "{{ vm_name }}"
    vm_size: "{{ vm_size }}"
    admin_username: "{{ username }}"
    admin_password: "{{ password }}"
    managed_disk_type: "{{ disk_type }}"
    network_interfaces: "{{vm_name}}{{ network_interface_name }}"
    image:
      offer: 0001-com-ubuntu-server-jammy
      publisher: Canonical
      sku: 22_04-lts-gen2
      version: latest
